---
title: 操作系统、内存、线程
date: 2020-6-29 7:03:00
tags:  basis software
categories: 软件基础
description:  希望自己像讲故事一样学习。（所有内容观点截止2009年——书本发布时间。但是无论在什么时期，理论应该是大致类似的）
---

### 操作系统
#### 基本硬件架构
对于程序开发者来说，最重要的硬件组成就是：CPU、内存、I/O(输入输出设备)控制芯片。
* 早期硬件架构
对于这三个硬件来说，运行速率最高的是CPU、其次是内存、其次是I/O。简单的早期计算机硬件模型中，使用PCI Bridge(北桥)**系统总线**连接所有高速设备（CPU、内存），PCI Bridge的频率与内存一致。然后使用ISA Bridge(南桥)**ISA 总线**连接磁盘、USB、键盘、鼠标等所有低速设备。
* SMP与多核
由于制造工艺的问题，CPU的运行频率到了4GHz的时候，就一直没法继续提升。于是就产生了**对称多处理器**，简单来说就是用增加CPU的数量来提高运行速率。

#### 基本计算机软件结构
计算机软件体系的一个设计要点就是：分层结构。最上层的是**应用程序**；应用程序使用**应用程序接口**调用**运行库**；运行库使用**系统调用接口**来访问**操作系统内核**；操作系统内核使用硬件**驱动程序**来使用硬件。

#### 操作系统的工作
操作系统的一个主要功能是提供抽象接口，另一个主要功能就是管理硬件资源。
* 让CPU不用打盹
早期操作系统使用时间片轮训的**分时系统**来处理任务，但是分时系统无法解决一个程序强占CPU的情况。所以就出现了**多任务系统**，多任务系统中，每个应用程序都是以**进程**的方式运行在比操作系统权限更低的级别，每个进程都有自己的独立地址空间。CPU也由操作系统根据进程的优先级来统一分配，运行操过了一段时间，操作系统就会暂停进程。
* 操作系统使用**硬件驱动程序**来管理和使用硬件。

### 内存
在多任务分时系统中，CPU和I/O都可以很好地处理进程间的共享问题，但是将有限的物理内存分配给多个进程使用则不是太容易。
#### 虚拟地址
将程序给定的地址作为**虚拟地址**，然后通过某些映射，将虚拟地址转换成实际物理地址。每个进程都有自己独立的虚拟地址空间，每个进程也只能访问自己的地址空间。这样就将进程之间的内存访问隔离开来了。
真正的内存使用过程中，每切换一个进程后，虚拟地址空间都得完全映射到物理地址中，比如程序A需要10KB内存，则就真正在物理地址中开辟10KB内存，然后将虚拟地址空间映射过去，程序执行的时候就可以想象成独享这一片内存。如果内存不足，则会将先换出正在使用磁盘的整个程序。
所以这也存在内存使用效率不高的情况。
#### 分页
分页就是将虚拟地址和物理地址都进行分页，每一页的大小是固定的。然后把常用的数据结构和代码页装载到内存中，把不常用的代码和数据保存到磁盘中。这样物理地址空间就可以供多个虚拟地址空间使用。也就提高了内存使用效率。

### 线程
线程是本书的重点！
线程是一个**轻量级的进程**，是程序的最小执行单元。一个标准的线程由线程ID、当前指令指针(PC)、寄存器集合和堆栈组成。**一个进程由多个线程组成，各个线程之间共享程序的内存空间**。
#### 线程访问权限
线程可以访问进程内存中的所有数据。但是线程拥有自己的私有存储空间
* 栈：(比如局部变量)
* 线程局部存储TLS：(是指操作系统为线程单独提供的私有空间，比如iOS的ARC中Autorelease对象作为返回值时有使用TLS作为临时缓存)
* 寄存器：(比如函数参数)
#### 线程调度与优先级：
当线程数小于等于处理器数量时，是真正的并发，不同的线程运行在不同的处理器上，彼此不相干。当时当线程数量大于处理器数量时，则至少有一个处理器会运行多个线程。
在单个处理器处理多个线程时，操作系统会让这些线程轮流执行。这些线程的执行过程则是根据线程的状态进行调度。
* 运行
* 就绪
* 等待
处于运行中的线程由一个时间片的运行时间，如果时间片内没有运行完成，则出来进入就绪状态，
